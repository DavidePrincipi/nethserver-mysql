#!/bin/sh

backup_dir=/var/lib/nethserver/backup/mysql/

status=$(/sbin/e-smith/config getprop mysqld status)
if [ "$status" = "disabled" ]
then
    echo "mysqld is disabled - no tables restored" >&2
    exit 0
fi

# empty current client configuration
> /root/.my.cnf

# restore old mysql db
/usr/bin/mysql -e "drop database mysql" 2> /dev/null
/usr/bin/mysql < $backup_dir/mysql.dump
rm -f $backup_dir/mysql.dump

# replace old password
/usr/bin/mysqladmin password `cat /etc/my.pwd`

# re-expand /root/.my.cnf
/sbin/e-smith/expand-template /root/.my.cnf

# update privileges tables (if needed)
/usr/bin/mysql_upgrade >/dev/null

# restore all dumps
for db in $(ls $backup_dir/*.dump 2> /dev/null)
do
    mv $db /etc/e-smith/sql/init/01_$(basename $db .dump).sql
done

/etc/init.d/mysql.init start
